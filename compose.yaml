services:
  # --- THE ENGINE (Zone B) ---
  llama-server:
    # UPDATED REPO: Changed 'ggerganov' to 'ggml-org'
    image: ghcr.io/ggml-org/llama.cpp:server-cuda
    container_name: factory-inference-01
    restart: always
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    volumes:
      - ./models/gguf:/models
    ports:
      - "8000:8000"
    command: >
      -m /models/Meta-Llama-3.1-70B-Instruct.Q4_K_M.gguf
      --host 0.0.0.0
      --port 8000
      --n-gpu-layers 99
      --ctx-size 16384
      --tensor-split 14,13,12,12,12,18
      --parallel 1
      --flash-attn on

  # --- THE INTERFACE (Zone B) ---
  open-webui:
    image: ghcr.io/open-webui/open-webui:main
    container_name: factory-ui
    restart: always
    network_mode: "host" 
    environment:
      - OPENAI_API_BASE_URL=http://localhost:8000/v1
      - OPENAI_API_KEY=sovereign-key
      - PORT=8080
   # INJECTED SECRET: Loads from .env file
      - LDAP_BIND_PASSWORD=${LDAP_BIND_PASSWORD}
   # Tell WebUI to use S3/MinIO
      - STORAGE_PROVIDER=${STORAGE_PROVIDER}
      - S3_ACCESS_KEY_ID=${S3_ACCESS_KEY_ID}
      - S3_SECRET_ACCESS_KEY=${S3_SECRET_ACCESS_KEY}
      - S3_BUCKET_NAME=${S3_BUCKET_NAME}
      - S3_ENDPOINT_URL=${S3_ENDPOINT_URL}
      - S3_REGION=${S3_REGION}
    volumes:
      - open-webui-data:/app/backend/data

   # --- THE VAULT (Zone C) ---
  
  # 1. Hot Storage: Operational DB + Vector Search
  database:
    image: pgvector/pgvector:pg16
    container_name: factory-db
    restart: always
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
    ports:
      - "5432:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # 2. Cold Storage: S3 Compatible Object Store
  minio:
    image: minio/minio:latest
    container_name: factory-minio
    restart: always
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD}
    ports:
      - "9000:9000"  # API Port (S3 Protocol)
      - "9001:9001"  # Web Console
    volumes:
      - minio-data:/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3

volumes:
  open-webui-data:
  postgres-data:
  minio-data:
